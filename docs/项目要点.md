## é¡¹ç›®çš„ä¸€äº›è¦ç‚¹

ä»å…¥å£ä¸€ç‚¹ç‚¹çœ‹

#### 1. `#!/usr/bin/env node` æ˜¯å¹²å˜›ç”¨çš„ï¼Ÿ

è¿™ä¸€è¡Œè¢«ç§°ä¸º shebang /ÊƒÉªËˆbÃ¦Å‹/ lineï¼Œè¿™ä¸€è¡Œè¢«æ”¾åœ¨å¯æ‰§è¡Œçš„æ–‡æœ¬æ–‡ä»¶çš„å¤´éƒ¨ï¼Œç”¨æ¥å‘Šè¯‰ç±»ä¼¼äº unix å¹³å°ï¼Œä½¿ç”¨ä»€ä¹ˆå·¥å…·æ¥æ‰§è¡Œè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä»¥`#!`å¼€å¤´ï¼Œè¿™ä¸ªä¸€èˆ¬è¢«ç§°ä¸º shebang

å½“ä½¿ç”¨ç¯å¢ƒå˜é‡çš„æ–¹å¼å»è®¿é—®è¿™ä¸ªæ–‡ä»¶çš„æ—¶å€™å°±éœ€è¦è¿™ä¸€è¡Œå¼€å¤´

#### 2. ä½¿ç”¨ commander è¿›è¡Œå‘½ä»¤è¡Œäº¤äº’

è¿™ä¸ªæ˜¯ç”¨æ¥æ‰§è¡Œ`xx create`ç­‰å‘½ä»¤æ—¶æ‰€ç”¨åˆ°çš„å·¥å…·ï¼Œå®ƒå¯ä»¥æ–¹ä¾¿çš„è§£ææˆ‘ä»¬çš„å‚æ•°ï¼Œä»¥åŠä¸€äº›é¢å¤–çš„åŠŸèƒ½å¦‚å‚æ•°æç¤ºç­‰

#### 3. èŒè´£åˆ’åˆ†

```
æ³¨å…¥å‘½ä»¤
	- ç‰¹æ€§
	- è‡ªå®šä¹‰çš„æ³¨å…¥å‘½ä»¤çš„æ–¹æ³•
```

æ ¹æ®éœ€æ±‚åˆ†æå¯ä»¥å¾—åˆ°ï¼Œè„šæ‰‹æ¶åšäº†è¿™ä¹ˆå‡ ä»¶äº‹æƒ…ï¼š

1. ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’
2. ç”Ÿæˆæ–‡ä»¶
3. å®‰è£…ä¾èµ–

PromptManager æä¾›æ³¨å…¥äº¤äº’å‘½ä»¤çš„ apiï¼Œç„¶ååœ¨æ¯ä¸€ä¸ª module ä¸‹å£°æ˜æ‰€éœ€è¦æ³¨å…¥çš„å‘½ä»¤

ä»¥ babel ä¸ºä¾‹

```javascript
module.exports = (api) => {
	api.injectFeature({
		name: 'Babel',
		value: 'babel',
		short: 'Babel',
		description:
			'Transpile modern JavaScript to older versions (for compatibility)',
		link: 'https://babeljs.io/',
		checked: true,
	});
};
```

åœ¨ api ä¸­åŒ…å«ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«ä¸º`injectFeature`å’Œ`injectPrompt`

`injectFeature`ç”¨æ¥æ³¨å…¥ç‰¹æ€§ï¼Œä¾‹å¦‚åœ¨åˆšå¼€å§‹çš„æ—¶å€™ä¼šé€‰æ‹©ç‰¹æ€§ï¼Œè¿™ä¸ªæ³¨å…¥çš„å°±æ˜¯é€‰é¡¹

`injectPrompt`ç”¨æ¥æ³¨å…¥ç‰¹å®šçš„äº¤äº’ï¼Œä¾‹å¦‚ eslint ä¸­é€‰æ‹©ä»€ä¹ˆè§„åˆ™ï¼Œå…·ä½“å¦‚ä¸‹

```javascript
module.exports = (api) => {
	api.injectFeature({
		name: 'Linter',
		value: 'eslint',
		short: 'Linter',
		description: 'Find and fix problems in your JavaScript code',
		link: 'https://eslint.org/',
		checked: true,
	});

	api.injectPrompt({
		type: 'list',
		name: 'lintRule',
		message: 'è¯·é€‰æ‹©ä»£ç é£æ ¼',
		choices: ['airbnb', 'standard', 'none'],
		when: ({ features }) => features.includes('eslint'),
	});

	api.injectPrompt({
		type: 'confirm',
		name: 'lintWithPrettier',
		message: 'æ˜¯å¦ä½¿ç”¨ Prettier',
		default: false,
		when: ({ features }) => features.includes('eslint'),
	});
};
```

å…³äºä¸ºä»€ä¹ˆæœ‰è¿™ç§æ•°æ®ç»“æ„ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹ `inquirer` çš„ç”¨æ³•

å½“æˆ‘ä»¬å‘½ä»¤éƒ½æ³¨å…¥å®Œæ¯•åï¼Œå°±å¯ä»¥ä½¿ç”¨ inquire ä¸ç”¨æˆ·è¿›è¡Œé€‰é¡¹äº¤äº’

```javascript
const answers = await inquirer.prompt(promptManager.getPrompts());
```

è¿™æ ·å°±èƒ½è·å–åˆ°æˆ‘ä»¬æ‰€éœ€è¦çš„ç­”æ¡ˆ

Generator ç”¨æ¥ç”Ÿæˆæ–‡ä»¶ï¼Œç®¡ç†`package.json`ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒå¤æ‚çš„éƒ¨åˆ†

æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¸€ä¸‹æ’ä»¶æœ‰ä»€ä¹ˆéœ€æ±‚

å½“ç„¶æ˜¯æ‰©å±•`package.json`å’Œæ·»åŠ æ–°çš„æ–‡ä»¶

åœ¨ generator çš„ api ä¸­æä¾›äº†æ³¨å…¥æ–‡ä»¶çš„æ–¹æ³•å’Œä¿®æ”¹ package.json çš„æ–¹æ³•

ç„¶åæˆ‘ä»¬å»å¼•ç”¨æ¯ä¸ªæ’ä»¶æ¨¡å—ï¼Œè¯¥æ’ä»¶æ¨¡å—ä¸‹æœ‰ä¸€ä¸ª generator æ–‡ä»¶å¤¹ï¼ŒèŒè´£ä¸ºæ³¨å…¥æ–‡ä»¶/ä¿®æ”¹ package.json

åœ¨æ–‡ä»¶å¤¹ä¸‹æœ‰ä¸€ä¸ªå…¥å£æ–‡ä»¶ï¼Œç”¨æ¥è¡¨ç¤ºæ³¨å…¥ä»€ä¹ˆæ–‡ä»¶

æˆ‘ä»¬ä»¥ eslint ä¸ºä¾‹

```javascript
const ruleDependencyMap = {
	airbnb: {
		'eslint-config-airbnb-base': 'latest',
	},
	standard: {
		'eslint-config-standard': 'latest',
		'eslint-plugin-promise': 'latest',
		'eslint-plugin-node': 'latest',
	},
	none: {},
};

module.exports = (api, { features, lintRule, lintWithPrettier }) => {
	const hasBabel = features.includes('babel');

	api.injectFile('./template', {
		hasBabel,
		lintRule,
		lintWithPrettier,
	});

	const devDependencies = {
		eslint: 'latest',
		'eslint-plugin-import': 'latest',
	};

	if (hasBabel) {
		devDependencies['@babel/eslint-parser'] = 'latest';
	}

	Object.keys(ruleDependencyMap[lintRule]).forEach((d) => {
		devDependencies[d] = 'latest';
	});

	if (lintWithPrettier) {
		devDependencies['eslint-config-prettier'] = 'latest';
	}

	api.extendPackage({
		devDependencies,
		scripts: {
			lint: 'eslint --fix',
		},
	});
};
```

å¯ä»¥çœ‹å‡ºæ¥ generator ä¸­æä¾›äº†ä¸¤ä¸ªæ–¹æ³•ï¼š injectFile å’Œ extendPackageï¼Œåœ¨è¯¥å‡½æ•°ä¸­è¿˜æä¾›äº†å¦ä¸€ä¸ªå‚æ•°ï¼Œé‚£å°±æ˜¯ç”¨æˆ·æ‰€é€‰æ‹©çš„ç­”æ¡ˆï¼Œä¾‹å¦‚è¿™é‡Œæœ‰æ˜¯å¦é€‰æ‹© airbnb çš„é…ç½®æˆ– standardjs çš„é…ç½®

å‰è€…è¡¨ç¤ºæ³¨å…¥æ–‡ä»¶ï¼Œåè€…è¡¨ç¤ºæ‰©å±• package.json

æœ€åä¸€ä¸ªå°±æ˜¯ PackageManager æ¨¡å—ï¼Œç”¨æ¥ç®¡ç†ä¾èµ–å®‰è£…ï¼Œç°é˜¶æ®µè¿˜æ¯”è¾ƒç®€å•ï¼Œåªæ”¯æŒäº†ä½¿ç”¨ä»€ä¹ˆå·¥å…·å»å®‰è£…ï¼Œæ²¡æœ‰æ”¯æŒåˆ‡æ¢æº

```javascript
class PackageManager {
	constructor(context, tool) {
		this.context = context;
		this.tool = tool;
	}

	async install() {
		console.log('ğŸ§¶ ä¸‹è½½ä¾èµ–ä¸­...');
		// console.log(this.tool, toolCommands[this.tool]['install'], this.context);
		await executeCommand(
			this.tool,
			toolCommands[this.tool]['install'],
			this.context
		);
	}
```

#### 4. æ³¨å…¥æ–‡ä»¶

ä¿®æ”¹ package.json æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œç›´æ¥ mergeOption å°±å¯ä»¥äº†ï¼Œä½†æ˜¯æ³¨å…¥æ–‡ä»¶è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„

æˆ‘ä»¬åœ¨ api ä¸­è°ƒç”¨çš„æ–¹æ³•å¦‚ä¸‹:

```javascript
api.injectFile('./template', {
	hasBabel,
	lintRule,
	lintWithPrettier,
});
```

ä½¿ç”¨çš„æ˜¯ç›¸å¯¹è·¯å¾„çš„æ–¹å¼ï¼Œä½†æ˜¯å¯¹äºæ‰§è¡Œè¿™ä¸ªå‡½æ•°çš„åœ°æ–¹ï¼Œå®ƒéœ€è¦è·å–åˆ°è¿™ä¸ªå‡½æ•°çš„ç›¸å¯¹è·¯å¾„
